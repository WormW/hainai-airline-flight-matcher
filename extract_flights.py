#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ·å—èˆªç©ºèˆªç­é…å¯¹å™¨ - æ•°æ®æå–è„šæœ¬
ğŸ¤– AI Generated by Augment + Claude Sonnet 4

æå–èˆªç­æ•°æ®åˆ°JSONæ–‡ä»¶

ä½œè€…: WormW (with Augment + Claude Sonnet 4)
"""

import re
import json

def extract_flights_data():
    """ä»HTMLæ–‡ä»¶ä¸­æå–èˆªç­æ•°æ®"""
    
    # è¯»å–HTMLæ–‡ä»¶
    with open('HNA2666_flight_map_v0807e.html', 'r', encoding='utf-8') as f:
        content = f.read()
    
    # æŸ¥æ‰¾èˆªç­æ•°æ®çš„å¼€å§‹å’Œç»“æŸä½ç½®
    start_pattern = r'const flights = \['
    end_pattern = r'^\s*\];\s*$'
    
    # æ‰¾åˆ°å¼€å§‹ä½ç½®
    start_match = re.search(start_pattern, content, re.MULTILINE)
    if not start_match:
        print("æœªæ‰¾åˆ°èˆªç­æ•°æ®å¼€å§‹æ ‡è®°")
        return None
    
    start_pos = start_match.end() - 1  # åŒ…å« [
    
    # ä»å¼€å§‹ä½ç½®å¾€åæŸ¥æ‰¾ç»“æŸä½ç½®
    lines = content[start_pos:].split('\n')
    flights_lines = []
    bracket_count = 0
    found_start = False
    
    for line in lines:
        if '[' in line and not found_start:
            found_start = True
            bracket_count += line.count('[') - line.count(']')
            flights_lines.append(line)
        elif found_start:
            bracket_count += line.count('[') - line.count(']')
            flights_lines.append(line)
            if bracket_count == 0 and '];' in line:
                break
    
    # ç»„åˆèˆªç­æ•°æ®æ–‡æœ¬
    flights_text = '\n'.join(flights_lines)
    
    # ç§»é™¤æœ«å°¾çš„ ];
    flights_text = re.sub(r'^\s*\];\s*$', ']', flights_text, flags=re.MULTILINE)
    
    try:
        # è§£æJSON
        flights_data = json.loads(flights_text)
        print(f"æˆåŠŸæå– {len(flights_data)} æ¡èˆªç­æ•°æ®")
        
        # ä¿å­˜åˆ°JSONæ–‡ä»¶
        with open('flights.json', 'w', encoding='utf-8') as f:
            json.dump(flights_data, f, ensure_ascii=False, indent=2)
        
        print("èˆªç­æ•°æ®å·²ä¿å­˜åˆ° flights.json")
        return flights_data
        
    except json.JSONDecodeError as e:
        print(f"JSONè§£æé”™è¯¯: {e}")
        # ä¿å­˜åŸå§‹æ–‡æœ¬ç”¨äºè°ƒè¯•
        with open('flights_raw.txt', 'w', encoding='utf-8') as f:
            f.write(flights_text)
        print("åŸå§‹æ•°æ®å·²ä¿å­˜åˆ° flights_raw.txt ç”¨äºè°ƒè¯•")
        return None

if __name__ == "__main__":
    extract_flights_data()
